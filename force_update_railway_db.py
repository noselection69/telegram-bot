#!/usr/bin/env python3
"""
üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î Railway
–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ù–ê–ü–†–Ø–ú–£–Æ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ PostgreSQL –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ë–ü –∑–∞–¥–∞–Ω–∏—è —á–µ—Ä–µ–∑ RAW SQL
"""
import os
import sys
from sqlalchemy import create_engine, text

# –ü–æ–ª—É—á–∞–µ–º DATABASE_URL –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
DATABASE_URL = os.environ.get('DATABASE_URL')

if not DATABASE_URL:
    print("‚ùå –û–®–ò–ë–ö–ê: DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!")
    print("   –£–∫–∞–∂–∏—Ç–µ DATABASE_URL –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Railway")
    sys.exit(1)

print(f"üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ë–î Railway...")
print(f"   URL: {DATABASE_URL[:50]}...")

try:
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ë–î - –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º asyncpg URL –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    sync_url = DATABASE_URL
    if "+asyncpg" in sync_url:
        sync_url = sync_url.replace("+asyncpg", "+psycopg2")
    elif "postgresql://" in sync_url and "+psycopg2" not in sync_url:
        sync_url = sync_url.replace("postgresql://", "postgresql+psycopg2://")
    
    print(f"   Converting URL for sync access...")
    print(f"   Sync URL: {sync_url[:50]}...")
    
    engine = create_engine(sync_url, echo=False)
    
    with engine.connect() as conn:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É - –∏—Å–ø–æ–ª—å–∑—É–µ–º raw SQL –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        result = conn.execute(text("SELECT COUNT(*) FROM bp_tasks;"))
        current_count = result.scalar()
        print(f"\nüìä –¢–µ–∫—É—â–∏—Ö –ë–ü –∑–∞–¥–∞–Ω–∏–π –≤ –ë–î: {current_count}")
        
        if current_count != 59:
            print(f"‚ö†Ô∏è  –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å (—Ç–µ–∫—É—â–µ–µ != 59)")
            print(f"üîÑ –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è...")
            
            # –£–¥–∞–ª—è–µ–º –í–°–ï —Å—Ç–∞—Ä—ã–µ —á–µ—Ä–µ–∑ RAW SQL
            conn.execute(text("TRUNCATE TABLE bp_tasks CASCADE;"))
            conn.commit()
            print(f"‚úÖ –¢–∞–±–ª–∏—Ü–∞ –æ—á–∏—â–µ–Ω–∞")
            
            print(f"‚ûï –î–æ–±–∞–≤–ª—è–µ–º 59 –Ω–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π —á–µ—Ä–µ–∑ RAW SQL...")
            
            # RAW SQL –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ 59 –∑–∞–¥–∞–Ω–∏–π (–≤—Å–µ 59 –≤ –æ–¥–Ω–æ–º VALUES)
            bp_tasks_sql = """
            INSERT INTO bp_tasks (name, category, bp_without_vip, bp_with_vip) VALUES
            ('3 —á–∞—Å–∞ –≤ –æ–Ω–ª–∞–π–Ω–µ (–º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –∑–∞ –¥–µ–Ω—å)', '–õ–µ–≥–∫–∏–µ', 2, 4),
            ('–ù—É–ª–∏ –≤ –∫–∞–∑–∏–Ω–æ', '–õ–µ–≥–∫–∏–µ', 2, 4),
            ('–£—Å–ø–µ—à–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≤ —Ç–∏—Ä–µ', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –∫–∏–Ω–æ—Å—Ç—É–¥–∏—é', '–õ–µ–≥–∫–∏–µ', 2, 4),
            ('–ö—É–ø–∏—Ç—å –ª–æ—Ç–µ—Ä–µ–π–Ω—ã–π –±–∏–ª–µ—Ç', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–í—ã–∏–≥—Ä–∞—Ç—å –≥–æ–Ω–∫—É –≤ –∫–∞—Ä—Ç–∏–Ω–≥–µ', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–ü—Ä–æ–µ—Ö–∞—Ç—å 1 —É–ª–∏—á–Ω—É—é –≥–æ–Ω–∫—É (—Å—Ç–∞–≤–∫–∞ –º–∏–Ω–∏–º—É–º 1000$)', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–î–æ–±–∞–≤–∏—Ç—å 5 –≤–∏–¥–µ–æ –≤ –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–µ', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–ü–æ—Å–µ—Ç–∏—Ç—å –ª—é–±–æ–π —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–ó–∞–π—Ç–∏ –≤ –ª—é–±–æ–π –∫–∞–Ω–∞–ª –≤ Brawl', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–ü–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫ –ª—é–±–æ–π –∞–Ω–∫–µ—Ç–µ –≤ Match', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∑–∞ DP —Å–µ—Ä–µ–±—Ä—è–Ω–Ω—ã–π, –∑–æ–ª–æ—Ç–æ–π –∏–ª–∏ driver –∫–µ–π—Å', '–õ–µ–≥–∫–∏–µ', 10, 20),
            ('–ö–∏–Ω—É—Ç—å –º—è—á –ø–∏—Ç–æ–º—Ü—É 15 —Ä–∞–∑', '–õ–µ–≥–∫–∏–µ', 2, 4),
            ('15 –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ø–∏—Ç–æ–º—Ü–µ–º –∫–æ–º–∞–Ω–¥', '–õ–µ–≥–∫–∏–µ', 2, 4),
            ('–°—Ç–∞–≤–∫–∞ –≤ –∫–æ–ª–µ—Å–µ —É–¥–∞—á–∏ –≤ –∫–∞–∑–∏–Ω–æ (–º–µ–∂—Å–µ—Ä–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–µ—Å–æ)', '–õ–µ–≥–∫–∏–µ', 3, 6),
            ('–ü—Ä–æ–µ—Ö–∞—Ç—å 1 —Å—Ç–∞–Ω—Ü–∏—é –Ω–∞ –º–µ—Ç—Ä–æ', '–õ–µ–≥–∫–∏–µ', 2, 4),
            ('–ü–æ—á–∏–Ω–∏—Ç—å –¥–µ—Ç–∞–ª—å –≤ –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–µ', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–ó–∞–±—Ä–æ—Å–∏—Ç—å 2 –º—è—á–∞ –≤ –±–∞—Å–∫–µ—Ç–±–æ–ª–µ', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–ó–∞–±–∏—Ç—å 2 –≥–æ–ª–∞ –≤ —Ñ—É—Ç–±–æ–ª–µ', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–ü–æ–±–µ–¥–∏—Ç—å –≤ –∞—Ä–º—Ä–µ—Å—Ç–ª–∏–Ω–≥–µ', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–ü–æ–±–µ–¥–∏—Ç—å –≤ –¥–∞—Ä—Ç—Å', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–ü–æ–∏–≥—Ä–∞—Ç—å 1 –º–∏–Ω—É—Ç—É –≤ –≤–æ–ª–µ–π–±–æ–ª', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–ü–æ–∏–≥—Ä–∞—Ç—å 1 –º–∏–Ω—É—Ç—É –≤ –Ω–∞—Å—Ç–æ–ª—å–Ω—ã–π —Ç–µ–Ω–Ω–∏—Å', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–ü–æ–∏–≥—Ä–∞—Ç—å 1 –º–∏–Ω—É—Ç—É –≤ –±–æ–ª—å—à–æ–π —Ç–µ–Ω–Ω–∏—Å', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–°—ã–≥—Ä–∞—Ç—å –≤ –º–∞—Ñ–∏—é –≤ –∫–∞–∑–∏–Ω–æ', '–õ–µ–≥–∫–∏–µ', 3, 6),
            ('–°–¥–µ–ª–∞—Ç—å –ø–ª–∞—Ç–µ–∂ –ø–æ –ª–∏–∑–∏–Ω–≥—É', '–õ–µ–≥–∫–∏–µ', 1, 2),
            ('–ü–æ—Å–∞–¥–∏—Ç—å —Ç—Ä–∞–≤—É –≤ —Ç–µ–ø–ª–∏—Ü–µ', '–õ–µ–≥–∫–∏–µ', 4, 8),
            ('–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É –æ–±–µ–∑–±–æ–ª–∏–≤–∞—é—â–∏—Ö –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏', '–õ–µ–≥–∫–∏–µ', 4, 8),
            ('25 –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ —Å—Ç—Ä–æ–π–∫–µ', '–°—Ä–µ–¥–Ω–∏–µ', 2, 4),
            ('25 –¥–µ–π—Å—Ç–≤–∏–π –≤ –ø–æ—Ä—Ç—É', '–°—Ä–µ–¥–Ω–∏–µ', 2, 4),
            ('25 –¥–µ–π—Å—Ç–≤–∏–π –≤ —à–∞—Ö—Ç–µ', '–°—Ä–µ–¥–Ω–∏–µ', 2, 4),
            ('3 –ø–æ–±–µ–¥—ã –≤ –î—ç–Ω—Å –ë–∞—Ç—Ç–ª–∞—Ö', '–°—Ä–µ–¥–Ω–∏–µ', 2, 4),
            ('20 –ø–æ–¥—Ö–æ–¥–æ–≤ –≤ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–Ω–æ–º –∑–∞–ª–µ', '–°—Ä–µ–¥–Ω–∏–µ', 1, 2),
            ('10 –ø–æ—Å—ã–ª–æ–∫ –Ω–∞ –ø–æ—á—Ç–µ', '–°—Ä–µ–¥–Ω–∏–µ', 1, 2),
            ('10 –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ —Ñ–µ—Ä–º–µ', '–°—Ä–µ–¥–Ω–∏–µ', 1, 2),
            ('–ü–æ—Ç—É—à–∏—Ç—å 25 ''–æ–≥–æ–Ω—å–∫–æ–≤'' –ø–æ–∂–∞—Ä–Ω—ã–º', '–°—Ä–µ–¥–Ω–∏–µ', 1, 2),
            ('–í—ã–ø–æ–ª–Ω–∏—Ç—å 3 –∑–∞–∫–∞–∑–∞ –¥–∞–ª—å–Ω–æ–±–æ–π—â–∏–∫–æ–º', '–°—Ä–µ–¥–Ω–∏–µ', 2, 4),
            ('–í—ã–∫–æ–ø–∞—Ç—å 1 —Å–æ–∫—Ä–æ–≤–∏—â–µ (–Ω–µ –º—É—Å–æ—Ä)', '–°—Ä–µ–¥–Ω–∏–µ', 1, 2),
            ('–í—ã–∏–≥—Ä–∞—Ç—å 5 –∏–≥—Ä –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–º –∫–æ–º–ø–ª–µ–∫—Å–µ —Å–æ —Å—Ç–∞–≤–∫–æ–π (–æ—Ç 100$)', '–°—Ä–µ–¥–Ω–∏–µ', 1, 2),
            ('–í—ã–∏–≥—Ä–∞—Ç—å 3 –ª—é–±—ã—Ö –∏–≥—Ä—ã –Ω–∞ –∞—Ä–µ–Ω–µ —Å–æ —Å—Ç–∞–≤–∫–æ–π (–æ—Ç 100$)', '–°—Ä–µ–¥–Ω–∏–µ', 1, 2),
            ('2 –∫—Ä—É–≥–∞ –Ω–∞ –ª—é–±–æ–º –º–∞—Ä—à—Ä—É—Ç–µ –∞–≤—Ç–æ–±—É—Å–Ω–∏–∫–∞', '–°—Ä–µ–¥–Ω–∏–µ', 2, 4),
            ('5 —Ä–∞–∑ —Å–Ω—è—Ç—å 100% —à–∫—É—Ä—É —Å –∂–∏–≤–æ—Ç–Ω—ã—Ö', '–°—Ä–µ–¥–Ω–∏–µ', 2, 4),
            ('–ó–∞–∫—Ä—ã—Ç—å 5 –∫–æ–¥–æ–≤ –≤ —Å–∏–ª–æ–≤—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö', '–°—Ä–µ–¥–Ω–∏–µ', 2, 4),
            ('–ü—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ 1 –∞—Ä–µ—Å—Ç –≤ –ö–ü–ó', '–°—Ä–µ–¥–Ω–∏–µ', 1, 2),
            ('–ü–æ–π–º–∞—Ç—å 20 —Ä—ã–±', '–°—Ä–µ–¥–Ω–∏–µ', 4, 8),
            ('–í—ã–ø–æ–ª–Ω–∏—Ç—å 2 –∫–≤–µ—Å—Ç–∞ –ª—é–±—ã—Ö –∫–ª—É–±–æ–≤', '–°—Ä–µ–¥–Ω–∏–µ', 4, 8),
            ('–ü—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ –¥–≤—É—Ö –∞–∏—Ä–¥—Ä–æ–ø–∞—Ö', '–°—Ä–µ–¥–Ω–∏–µ', 4, 8),
            ('–ó–∞–∫–∞–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –≤—Ä—É—á–Ω—É—é (–ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∂–∞—Ç—å –≤–∫–ª/–≤—ã–∫–ª)', '–¢—è–∂–µ–ª—ã–µ', 1, 2),
            ('–î–≤–∞ —Ä–∞–∑–∞ –æ–ø–ª–∞—Ç–∏—Ç—å —Å–º–µ–Ω—É –≤–Ω–µ—à–Ω–æ—Å—Ç–∏ —É —Ö–∏—Ä—É—Ä–≥–∞ –≤ EMS', '–¢—è–∂–µ–ª—ã–µ', 2, 4),
            ('7 –∑–∞–∫—Ä–∞—à–µ–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ—Ñ–∏—Ç–∏', '–¢—è–∂–µ–ª—ã–µ', 1, 2),
            ('–°–¥–∞—Ç—å 5 –∫–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥—ã', '–¢—è–∂–µ–ª—ã–µ', 2, 4),
            ('–£—á–∞—Å—Ç–∏–µ –≤ –∫–∞–ø—Ç–∞—Ö/–±–∏–∑–≤–∞—Ä–∞—Ö', '–¢—è–∂–µ–ª—ã–µ', 1, 2),
            ('–°–¥–∞—Ç—å –•–∞–º–º–µ—Ä —Å –í–ó–•', '–¢—è–∂–µ–ª—ã–µ', 3, 6),
            ('5 –≤—ã–¥–∞–Ω–Ω—ã—Ö –º–µ–¥–∫–∞—Ä—Ç –≤ EMS', '–¢—è–∂–µ–ª—ã–µ', 2, 4),
            ('–ó–∞–∫—Ä—ã—Ç—å 15 –≤—ã–∑–æ–≤–æ–≤ –≤ EMS', '–¢—è–∂–µ–ª—ã–µ', 2, 4),
            ('–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å 40 –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ WN', '–¢—è–∂–µ–ª—ã–µ', 2, 4),
            ('–í–∑–ª–æ–º–∞—Ç—å 15 –∑–∞–º–∫–æ–≤ –Ω–∞ –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è—Ö –¥–æ–º–æ–≤ –∏–ª–∏ –∞–≤—Ç–æ—É–≥–æ–Ω–∞—Ö', '–¢—è–∂–µ–ª—ã–µ', 2, 4),
            ('–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —É—á–µ—Ç 2 –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–¥–ª—è LSPD)', '–¢—è–∂–µ–ª—ã–µ', 1, 2),
            ('–í—ã–∫—É–ø–∏—Ç—å –¥–≤—É—Ö —á–µ–ª–æ–≤–µ–∫ –∏–∑ –ö–ü–ó', '–¢—è–∂–µ–ª—ã–µ', 2, 4);
            """
            
            conn.execute(text(bp_tasks_sql))
            conn.commit()
            print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: 59 –Ω–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π —á–µ—Ä–µ–∑ RAW SQL")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            result = conn.execute(text("SELECT COUNT(*) FROM bp_tasks;"))
            final_count = result.scalar()
            print(f"üìä –§–ò–ù–ê–õ–¨–ù–û–ï –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ë–ü –∑–∞–¥–∞–Ω–∏–π: {final_count}")
            
            if final_count == 59:
                print(f"\n‚úÖ‚úÖ‚úÖ –£–°–ü–ï–®–ù–û! 59 –ë–ü –∑–∞–¥–∞–Ω–∏–π —Ç–µ–ø–µ—Ä—å –≤ Railway PostgreSQL!")
                print(f"\n–û–∂–∏–¥–∞–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)...")
            else:
                print(f"\n‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ {final_count} –≤–º–µ—Å—Ç–æ 59!")
        else:
            print(f"‚úÖ –ë–ü –∑–∞–¥–∞–Ω–∏—è —É–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã (59 –∑–∞–¥–∞–Ω–∏–π)")
            # –ü—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
            result = conn.execute(text("SELECT DISTINCT category FROM bp_tasks ORDER BY category;"))
            categories = [row[0] for row in result.fetchall()]
            print(f"   –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: {', '.join(categories)}")
    
except Exception as e:
    print(f"\n‚ùå –û–®–ò–ë–ö–ê: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)
