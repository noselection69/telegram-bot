<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Финансовый Менеджер</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=2.1">
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h1 style="margin: 0;"><i class="fas fa-briefcase"></i> Финансовый Менеджер</h1>
                <button id="themeToggle" class="btn" style="flex: 0 0 auto; padding: 8px 12px; background: rgba(255,255,255,0.2); border: none; color: white; cursor: pointer; border-radius: 6px; font-size: 18px;"><i class="fas fa-sun"></i></button>
            </div>
            <div class="user-info" id="userInfo">
                <span id="userName">Загрузка...</span>
            </div>
        </header>

        <!-- Навигация -->
        <nav class="tabs">
            <button class="tab-btn active" data-tab="resell"><i class="fas fa-chart-pie"></i> Перекупа</button>
            <button class="tab-btn" data-tab="rental"><i class="fas fa-car"></i> Аренда</button>
            <button class="tab-btn" data-tab="bp-farm"><i class="fas fa-star"></i> Фарм BP</button>
            <button class="tab-btn" data-tab="timers"><i class="fas fa-hourglass-end"></i> Таймеры</button>
        </nav>

        <!-- Калькулятор перекупа -->
        <section id="resell-tab" class="tab-content active">
            <div class="section">
                
                <div class="form-group">
                    <button class="btn btn-primary" onclick="showAddItemForm()"><i class="fas fa-plus"></i> Добавить товар</button>
                    <button class="btn btn-info" onclick="showInventory()"><i class="fas fa-clipboard-list"></i> Инвентарь</button>
                    <button class="btn btn-info" onclick="showStatistics()"><i class="fas fa-chart-line"></i> Статистика</button>
                    <button class="btn btn-info" onclick="showHistory()"><i class="fas fa-scroll"></i> История продаж</button>
                    <button class="btn btn-info" onclick="showBuyPrices()"><i class="fas fa-coins"></i> Цены скупа</button>
                </div>

                <!-- Форма добавления товара -->
                <div id="addItemForm" class="form hidden">
                    <h3>Добавить новый товар</h3>
                    <form onsubmit="submitAddItem(event)">
                        <div class="form-field">
                            <label>Название товара:</label>
                            <input type="text" id="itemName" placeholder="Например: iPhone 13" required>
                        </div>

                        <div class="form-field">
                            <label>Категория:</label>
                            <select id="itemCategory" required>
                                <option value="ACCESSORY">Аксессуар</option>
                                <option value="THING">Вещь</option>
                                <option value="APARTMENT">Квартира</option>
                                <option value="HOUSE">Дом</option>
                                <option value="CAR">Автомобиль</option>
                            </select>
                        </div>

                        <div class="form-field">
                            <label>Цена покупки ($):</label>
                            <input type="number" id="itemPrice" placeholder="50000" step="0.01" required>
                        </div>

                        <div class="form-field">
                            <label>Комментарий:</label>
                            <textarea id="itemComment" placeholder="Дополнительная информация"></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Добавить</button>
                            <button type="button" class="btn btn-secondary" onclick="hideAddItemForm()"><i class="fas fa-xmark"></i> Отмена</button>
                        </div>
                    </form>
                </div>

                <!-- Список товаров -->
                <div id="itemsList" class="items-list">
                    <p class="loading">Загрузка товаров...</p>
                </div>
                
                <!-- Инвентарь -->
                <div id="inventoryView" class="view hidden">
                    <h3><i class="fas fa-clipboard-list"></i> Ваш инвентарь</h3>
                    <div id="inventoryList" class="items-list">
                        <p class="loading">Загрузка...</p>
                    </div>
                    <button class="btn btn-secondary" onclick="hideInventory()"><i class="fas fa-arrow-left"></i> Назад</button>
                </div>
                
                <!-- Статистика -->
                <div id="statisticsView" class="view hidden">
                    <h3><i class="fas fa-chart-line"></i> Статистика</h3>
                    
                    <!-- Фильтры по времени -->
                    <div style="margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-info" id="filterDay" onclick="loadStatistics('day')"><i class="fas fa-calendar"></i> За день</button>
                        <button class="btn btn-info" id="filterWeek" onclick="loadStatistics('week')"><i class="fas fa-chart-pie"></i> За неделю</button>
                        <button class="btn btn-info" id="filterAll" onclick="loadStatistics('all')" style="background: var(--accent-color);"><i class="fas fa-hourglass-end"></i> За всё время</button>
                    </div>
                    
                    <!-- Фильтры по типу сделок -->
                    <div style="margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-success" id="filterBest" onclick="loadStatistics(null, 'best')"><i class="fas fa-coins"></i> Выгодные</button>
                        <button class="btn btn-danger" id="filterWorst" onclick="loadStatistics(null, 'worst')"><i class="fas fa-chart-line"></i> Невыгодные</button>
                        <button class="btn btn-secondary" id="filterNone" onclick="loadStatistics()" style="background: var(--btn-bg);"><i class="fas fa-sparkles"></i> Все</button>
                    </div>
                    
                    <div id="statisticsContent"></div>
                    <button class="btn btn-secondary" onclick="hideStatistics()"><i class="fas fa-arrow-left"></i> Назад</button>
                </div>
                
                <!-- История -->
                <div id="historyView" class="view hidden">
                    <h3><i class="fas fa-scroll"></i> История продаж</h3>
                    <div id="historyList" class="items-list">
                        <p class="loading">Загрузка...</p>
                    </div>
                    <button class="btn btn-secondary" onclick="hideHistory()"><i class="fas fa-arrow-left"></i> Назад</button>
                </div>
                
                <!-- Цены скупа -->
                <div id="buyPricesView" class="view hidden">
                    <h3><i class="fas fa-coins"></i> Цены скупа</h3>
                    
                    <div class="form buy-price-form">
                        <h4 style="margin-bottom: 10px;">Добавить цену</h4>
                        <div class="buy-price-inputs">
                            <input type="text" id="itemNameInput" placeholder="Название товара (5G iPhone)" class="buy-price-input" tabindex="1" style="padding: 8px; border-radius: 6px; border: 1px solid #404040; background: #2d2d2d; color: #e0e0e0;">
                            <input type="text" id="itemPriceInput" placeholder="Цена (числа и буквы)" class="buy-price-input" tabindex="2" style="padding: 8px; border-radius: 6px; border: 1px solid #404040; background: #2d2d2d; color: #e0e0e0;">
                            <button class="btn btn-success buy-price-btn" onclick="submitBuyPrice()" tabindex="3"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <input type="text" id="buyPriceSearch" placeholder="Поиск..." onkeyup="searchBuyPrices()" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #404040; background: #2d2d2d; color: #e0e0e0;">
                    </div>
                    
                    <div id="buyPricesList" class="items-list">
                        <p class="loading">Загрузка...</p>
                    </div>
                    <button class="btn btn-secondary" onclick="hideBuyPrices()"><i class="fas fa-arrow-left"></i> Назад</button>
                </div>
            </div>
        </section>

        <!-- Управление арендой -->
        <section id="rental-tab" class="tab-content">
            <div class="section">
                
                <div class="form-group">
                    <button class="btn btn-primary" onclick="showAddCarForm()"><i class="fas fa-plus"></i> Добавить авто</button>
                    <button class="btn btn-info" onclick="showCars()"><i class="fas fa-car"></i> Мои авто</button>
                    <button class="btn btn-info" onclick="showRentalStats()"><i class="fas fa-chart-pie"></i> Статистика</button>
                    <button class="btn btn-info" onclick="showActiveRentals()"><i class="fas fa-bell"></i> Активные аренды</button>
                </div>

                <!-- Форма добавления авто -->
                <div id="addCarForm" class="form hidden">
                    <h3>Добавить новый автомобиль</h3>
                    <form onsubmit="submitAddCar(event)">
                        <div class="form-field">
                            <label>Название/марка:</label>
                            <input type="text" id="carName" placeholder="Например: BMW X5" required>
                        </div>

                        <div class="form-field">
                            <label>Стоимость авто ($):</label>
                            <input type="number" id="carCost" placeholder="500000" step="0.01" required>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Добавить</button>
                            <button type="button" class="btn btn-secondary" onclick="hideAddCarForm()"><i class="fas fa-xmark"></i> Отмена</button>
                        </div>
                    </form>
                </div>

                <!-- Список авто -->
                <div id="carsList" class="cars-list">
                    <p class="loading">Загрузка автомобилей...</p>
                </div>
                
                <!-- Мои авто -->
                <div id="carsView" class="view hidden">
                    <h3><i class="fas fa-car"></i> Мои автомобили</h3>
                    <div id="carsList2" class="cars-list">
                        <p class="loading">Загрузка...</p>
                    </div>
                    <button class="btn btn-secondary" onclick="hideCars()"><i class="fas fa-arrow-left"></i> Назад</button>
                </div>
                
                <!-- Статистика аренды -->
                <div id="rentalStatsView" class="view hidden">
                    <h3><i class="fas fa-chart-pie"></i> Статистика аренды</h3>
                    <div id="rentalStatsContent"></div>
                    <button class="btn btn-secondary" onclick="hideRentalStats()"><i class="fas fa-arrow-left"></i> Назад</button>
                </div>
                
                <!-- Активные аренды -->
                <div id="activeRentalsView" class="view hidden">
                    <h3><i class="fas fa-bell"></i> Активные аренды</h3>
                    <div id="activeRentalsList" class="items-list">
                        <p class="loading">Загрузка...</p>
                    </div>
                    <button class="btn btn-secondary" onclick="hideActiveRentals()"><i class="fas fa-arrow-left"></i> Назад</button>
                </div>
            </div>
        </section>
    </div>

    <!-- Модальное окно сдачи авто в аренду -->
    <div id="rentalModal" class="modal hidden">
        <div class="modal-content">
            <h3><i class="fas fa-coins"></i> Сдать авто в аренду</h3>
            <form onsubmit="submitRental(event)">
                <input type="hidden" id="rentalCarId">
                
                <div class="form-field">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="rentalPastToggle" onchange="toggleRentalPast()">
                        <span><i class="fas fa-calendar"></i> Прошлая аренда</span>
                    </label>
                </div>
                
                <div class="form-field">
                    <label>Цена за час ($):</label>
                    <input type="number" id="rentalPrice" placeholder="500" step="0.01" required>
                </div>

                <div class="form-field">
                    <label>Количество часов:</label>
                    <input type="number" id="rentalHours" placeholder="4" min="1" required>
                </div>

                <div class="form-field">
                    <label id="rentalEndTimeLabel">Время окончания (HH:MM или +N часов):</label>
                    <input type="text" id="rentalEndTime" placeholder="22:30 или +4" required>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Записать</button>
                    <button type="button" class="btn btn-secondary" onclick="closeRentalModal()"><i class="fas fa-xmark"></i> Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно редактирования аренды -->
    <div id="editRentalModal" class="modal hidden">
        <div class="modal-content">
            <h3><i class="fas fa-pen"></i> Редактировать аренду</h3>
            <form onsubmit="submitEditRental(event)">
                <input type="hidden" id="editRentalId">
                
                <div class="form-field">
                    <label>Автомобиль:</label>
                    <input type="text" id="editRentalCar" disabled style="background-color: #f0f0f0;">
                </div>
                
                <div class="form-field">
                    <label>Цена за час ($):</label>
                    <input type="number" id="editRentalPrice" placeholder="500" step="0.01" required oninput="updateEditRentalSum()">
                </div>

                <div class="form-field">
                    <label>Количество часов:</label>
                    <input type="number" id="editRentalHours" placeholder="4" min="1" required oninput="updateEditRentalSum()">
                </div>
                
                <div class="form-field">
                    <label>Новая сумма:</label>
                    <div style="font-size: 18px; font-weight: bold; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
                        <span id="editRentalNewSum">0</span>$
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Сохранить</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditRentalModal()"><i class="fas fa-xmark"></i> Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Вкладка Фарм BP -->
    <section id="bp-farm-tab" class="tab-content" style="padding: 0 !important; margin: 0 !important;">
        <div class="section" style="margin-bottom: 0;">
            
            <!-- Переключатель VIP - сверху -->
            <div class="vip-toggle-container">
                <label class="vip-toggle-label">
                    <input type="checkbox" id="platinumVipToggle" onchange="togglePlatinumVip()" class="vip-toggle-input">
                    <span class="vip-toggle-text"><i class="fas fa-gem"></i> Платинум VIP</span>
                </label>
            </div>
            <!-- Задания по категориям - СВЕРХУ -->
            <div id="bpTasksContainer" style="min-height: 20px;"></div>
            <!-- Статистика - СНИЗУ -->
            <div class="stat-group">
                <div class="stat-item">
                    <span class="stat-label"><i class="fas fa-sunrise"></i> Сегодня:</span>
                    <span class="stat-value" id="bpToday">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label"><i class="fas fa-calendar"></i> За неделю:</span>
                    <span class="stat-value" id="bpWeek">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label"><i class="fas fa-target"></i> Всего:</span>
                    <span class="stat-value" id="bpTotal">0</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Вкладка Таймеры -->
    <section id="timers-tab" class="tab-content">
        <div class="section">
            
            <!-- Стандартные таймеры -->
            <div class="timers-grid">
                <button class="timer-btn" data-timer-name="Почта" data-timer-duration="600" onclick="startTimer('Почта', 600)">
                    <div class="timer-icon"><i class="fas fa-envelope"></i></div>
                    <div class="timer-name">Почта</div>
                    <div class="timer-time">10:00</div>
                </button>
                
                <button class="timer-btn" data-timer-name="Механик" data-timer-duration="300" onclick="startTimer('Механик', 300)">
                    <div class="timer-icon"><i class="fas fa-wrench"></i></div>
                    <div class="timer-name">Механик</div>
                    <div class="timer-time">5:00</div>
                </button>
                
                <button class="timer-btn" data-timer-name="Автобус" data-timer-duration="180" onclick="startTimer('Автобус', 180)">
                    <div class="timer-icon"><i class="fas fa-bus"></i></div>
                    <div class="timer-name">Автобус</div>
                    <div class="timer-time">3:00</div>
                </button>
                
                <button class="timer-btn" data-timer-name="Автоугон" data-timer-duration="5400" onclick="startTimer('Автоугон', 5400)">
                    <div class="timer-icon"><i class="fas fa-car"></i></div>
                    <div class="timer-name">Автоугон</div>
                    <div class="timer-time">1:30:00</div>
                </button>
                
                <button class="timer-btn" data-timer-name="Сутенерка" data-timer-duration="5400" onclick="startTimer('Сутенерка', 5400)">
                    <div class="timer-icon"><i class="fas fa-user"></i></div>
                    <div class="timer-name">Сутенерка</div>
                    <div class="timer-time">1:30:00</div>
                </button>
                
                <button class="timer-btn" data-timer-name="Тир" data-timer-duration="5400" onclick="startTimer('Тир', 5400)">
                    <div class="timer-icon"><i class="fas fa-crosshairs"></i></div>
                    <div class="timer-name">Тир</div>
                    <div class="timer-time">1:30:00</div>
                </button>
                
                <button class="timer-btn" data-timer-name="Дрессировка" data-timer-duration="900" onclick="startTimer('Дрессировка', 900)">
                    <div class="timer-icon"><i class="fas fa-paw"></i></div>
                    <div class="timer-name">Дрессировка</div>
                    <div class="timer-time">15:00</div>
                </button>
            </div>
            
            <!-- Запущенные таймеры -->
            <div id="activeTimersContainer" class="active-timers-container hidden">
                <h3 style="margin-top: 20px; margin-bottom: 15px;"><i class="fas fa-clock"></i> Активные таймеры</h3>
                <div id="activeTimersList" class="timers-list"></div>
            </div>
            
            <!-- Кнопка добавления собственного таймера -->
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="showCustomTimerForm()">
                    <i class="fas fa-plus-circle"></i> Добавить свой таймер
                </button>
            </div>
            
            <!-- Форма добавления собственного таймера -->
            <div id="customTimerForm" class="form hidden" style="margin-top: 20px;">
                <h3>Создать свой таймер</h3>
                <div class="form-field">
                    <label>Название:</label>
                    <input type="text" id="customTimerName" placeholder="Например: Отдых" required>
                </div>
                
                <div class="form-field">
                    <label>Часы:</label>
                    <input type="number" id="customTimerHours" min="0" max="23" value="0" style="width: 100%;">
                </div>
                
                <div class="form-field">
                    <label>Минуты:</label>
                    <input type="number" id="customTimerMinutes" min="0" max="59" value="5" style="width: 100%;">
                </div>
                
                <div class="form-field">
                    <label>Секунды:</label>
                    <input type="number" id="customTimerSeconds" min="0" max="59" value="0" style="width: 100%;">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-success" onclick="startCustomTimer()"><i class="fas fa-play"></i> Запустить</button>
                    <button type="button" class="btn btn-secondary" onclick="hideCustomTimerForm()"><i class="fas fa-xmark"></i> Отмена</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Уведомление -->
    <div id="notification" class="notification hidden"></div>

    <script src="{{ url_for('static', filename='app.js') }}?v=2.1"></script>
</body>
</html>
